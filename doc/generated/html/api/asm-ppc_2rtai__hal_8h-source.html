<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: base/include/asm-ppc/rtai_hal.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">base</a>&nbsp;/&nbsp;<a class="el" href="dir_000015.html">include</a>&nbsp;/&nbsp;<a class="el" href="dir_000021.html">asm-ppc</a></div>
<h1>rtai_hal.h</h1><a href="asm-ppc_2rtai__hal_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00040 <span class="preprocessor">#ifndef _RTAI_ASM_PPC_HAL_H</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_ASM_PPC_HAL_H</span>
00042 <span class="preprocessor"></span>
00043 <span class="preprocessor">#include &lt;asm/rtai_vectors.h&gt;</span>
00044 <span class="preprocessor">#include &lt;rtai_types.h&gt;</span>
00045 
00046 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_NR_CPUS  CONFIG_RTAI_CPUS</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* !CONFIG_SMP */</span>
00049 <span class="preprocessor">#define RTAI_NR_CPUS  1</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CONFIG_SMP */</span>
00051 
00052 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> ffnz(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ul) {
00053 
00054         __asm__ __volatile__ (<span class="stringliteral">"cntlzw %0, %1"</span> : <span class="stringliteral">"=r"</span> (ul) : <span class="stringliteral">"r"</span> (ul &amp; (-ul)));
00055 
00056         <span class="keywordflow">return</span> 31 - ul;
00057 }
00058 
00059 <span class="comment">/* One of the silly thing of 32 bits PPCs, no 64 bits result for 32 bits mul. */</span>
00060 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_ullmul(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m0, 
00061                                              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> m1) {
00062 
00063     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> res;
00064     
00065     __asm__ __volatile__ (<span class="stringliteral">"mulhwu %0, %1, %2"</span>
00066                           : <span class="stringliteral">"=r"</span> (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;res)[0]) 
00067                           : <span class="stringliteral">"%r"</span> (m0), <span class="stringliteral">"r"</span> (m1));
00068     ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;res)[1] = m0*m1;
00069     
00070     <span class="keywordflow">return</span> res;
00071 }
00072 
00073 <span class="comment">/* One of the silly thing of 32 bits PPCs, no 64 by 32 bits divide. */</span>
00074 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_ulldiv(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ull, 
00075                                              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> uld, 
00076                                              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *r) {
00077 
00078     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> q, rf;
00079     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> qh, rh, ql, qf;
00080     
00081     q = 0;
00082     rf = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long)(0xFFFFFFFF - (qf = 0xFFFFFFFF / uld) * uld) + 1ULL;
00083     
00084     <span class="keywordflow">while</span> (ull &gt;= uld) 
00085         {
00086         ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;q)[0] += (qh = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ull)[0] / uld);
00087         rh = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ull)[0] - qh * uld;
00088         q += rh * (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> long)qf + (ql = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ull)[1] / uld);
00089         ull = rh * rf + (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ull)[1] - ql * uld);
00090         }
00091     
00092     *r = ull;
00093     <span class="keywordflow">return</span> q;
00094 }
00095 
00096 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rtai_imuldiv(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> mult, <span class="keywordtype">int</span> div) {
00097 
00098     <span class="comment">/* Returns (int)i = (int)i*(int)(mult)/(int)div. */</span>
00099 
00100     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> q, r;
00101     
00102     q = rtai_ulldiv(rtai_ullmul(i, mult), div, &amp;r);
00103     
00104     <span class="keywordflow">return</span> (r + r) &gt; div ? q + 1 : q;
00105 }
00106 
00107 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_llimd(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ull, 
00108                                             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> mult, 
00109                                             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> div) {
00110 
00111     <span class="comment">/* Returns (long long)ll = (int)ll*(int)(mult)/(int)div. */</span>
00112 
00113     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> low;
00114     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> q, r;
00115     
00116     low  = rtai_ullmul(((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ull)[1], mult);       
00117     q = rtai_ulldiv(rtai_ullmul(((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ull)[0], mult) + 
00118                 ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;low)[0], div, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;low);
00119     low = rtai_ulldiv(low, div, &amp;r);
00120     ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;low)[0] += q;
00121     
00122     <span class="keywordflow">return</span> (r + r) &gt; div ? low + 1 : low;
00123 }
00124 
00125 
00126 <span class="preprocessor">#if defined(__KERNEL__) &amp;&amp; !defined(__cplusplus)</span>
00127 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/sched.h&gt;</span>
00128 <span class="preprocessor">#include &lt;asm/system.h&gt;</span>
00129 <span class="preprocessor">#include &lt;asm/io.h&gt;</span>
00130 <span class="preprocessor">#include &lt;asm/time.h&gt;</span>
00131 <span class="preprocessor">#include &lt;asm/rtai_atomic.h&gt;</span>
00132 <span class="preprocessor">#include &lt;asm/rtai_fpu.h&gt;</span>
00133 <span class="preprocessor">#include &lt;rtai_trace.h&gt;</span>
00134 
00135 <span class="preprocessor">#define RTAI_DOMAIN_ID  0x52544149</span>
00136 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_NR_SRQS    32</span>
00137 <span class="preprocessor"></span>
00138 <span class="preprocessor">#ifdef FIXME</span>
00139 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_SMP_NOTIFY_VECTOR    RTAI_APIC3_VECTOR</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_SMP_NOTIFY_IPI       RTAI_APIC3_IPI</span>
00141 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_APIC_TIMER_VECTOR    RTAI_APIC4_VECTOR</span>
00142 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_APIC_TIMER_IPI       RTAI_APIC4_IPI</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>
00145 <span class="preprocessor">#define RTAI_TIMER_DECR_IRQ       IPIPE_VIRQ_BASE</span>
00146 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_TIMER_8254_IRQ       RTAI_TIMER_DECR_IRQ</span>
00147 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_FREQ_8254            (rtai_tunables.cpu_freq)</span>
00148 <span class="preprocessor"></span><span class="preprocessor">#ifdef FIXME</span>
00149 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_APIC_ICOUNT          ((RTAI_FREQ_APIC + HZ/2)/HZ)</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_COUNTER_2_LATCH      0xfffe</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00152 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_LATENCY_8254         CONFIG_RTAI_SCHED_8254_LATENCY</span>
00153 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_SETUP_TIME_8254      500</span>
00154 <span class="preprocessor"></span>
00155 <span class="preprocessor">#ifdef FIXME</span>
00156 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_CALIBRATED_APIC_FREQ 0</span>
00157 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_FREQ_APIC            (rtai_tunables.apic_freq)</span>
00158 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_LATENCY_APIC         CONFIG_RTAI_SCHED_APIC_LATENCY</span>
00159 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_SETUP_TIME_APIC      1000</span>
00160 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>
00162 <span class="preprocessor">#define RTAI_TIME_LIMIT           0x7FFFFFFFFFFFFFFFLL</span>
00163 <span class="preprocessor"></span>
00164 <span class="preprocessor">#define RTAI_IFLAG                15</span>
00165 <span class="preprocessor"></span>
00166 <span class="preprocessor">#define rtai_cli()                adeos_stall_pipeline_from(&amp;rtai_domain)</span>
00167 <span class="preprocessor"></span><span class="preprocessor">#define rtai_sti()                adeos_unstall_pipeline_from(&amp;rtai_domain)</span>
00168 <span class="preprocessor"></span><span class="preprocessor">#define rtai_local_irq_save(x)    ((x) = adeos_test_and_stall_pipeline_from(&amp;rtai_domain))</span>
00169 <span class="preprocessor"></span><span class="preprocessor">#define rtai_local_irq_restore(x) adeos_restore_pipeline_from(&amp;rtai_domain,(x))</span>
00170 <span class="preprocessor"></span><span class="preprocessor">#define rtai_local_irq_flags(x)   ((x) = adeos_test_pipeline_from(&amp;rtai_domain))</span>
00171 <span class="preprocessor"></span><span class="preprocessor">#define rtai_local_irq_test()     adeos_test_pipeline_from(&amp;rtai_domain)</span>
00172 <span class="preprocessor"></span><span class="preprocessor">#define rtai_get_iflag_and_cli()  ((!adeos_test_and_stall_pipeline_from(&amp;rtai_domain)) &lt;&lt; RTAI_IFLAG)</span>
00173 <span class="preprocessor"></span><span class="comment">/* Use these ones when fiddling with the (local A)PIC */</span>
00174 <span class="preprocessor">#define rtai_hw_lock(flags)       adeos_hw_local_irq_save(flags)</span>
00175 <span class="preprocessor"></span><span class="preprocessor">#define rtai_hw_unlock(flags)     adeos_hw_local_irq_restore(flags)</span>
00176 <span class="preprocessor"></span><span class="preprocessor">#define rtai_hw_enable()          adeos_hw_sti()</span>
00177 <span class="preprocessor"></span><span class="preprocessor">#define rtai_hw_disable()         adeos_hw_cli()</span>
00178 <span class="preprocessor"></span>
00179 <span class="keyword">typedef</span> void (*rt_irq_handler_t)(<span class="keywordtype">unsigned</span> irq,
00180                                  <span class="keywordtype">void</span> *cookie);
00181 <span class="keywordtype">void</span> rtai_linux_cli(<span class="keywordtype">void</span>);
00182 
00183 <span class="keywordtype">void</span> rtai_linux_sti(<span class="keywordtype">void</span>);
00184 
00185 <span class="keywordtype">unsigned</span> rtai_linux_save_flags(<span class="keywordtype">void</span>);
00186 
00187 <span class="keywordtype">void</span> rtai_linux_restore_flags(<span class="keywordtype">unsigned</span> flags);
00188 
00189 <span class="keywordtype">void</span> rtai_linux_restore_flags_nosync(<span class="keywordtype">unsigned</span> flags, <span class="keywordtype">int</span> cpuid);
00190 
00191 <span class="keywordtype">unsigned</span> rtai_linux_save_flags_and_cli(<span class="keywordtype">void</span>);
00192 
00193 <span class="comment">/* Bits from rtai_status. */</span>
00194 <span class="preprocessor">#define RTAI_USE_APIC  0</span>
00195 <span class="preprocessor"></span>
00196 <span class="preprocessor">#define RTAI_CALIBRATED_CPU_FREQ   0</span>
00197 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_CPU_FREQ             (rtai_tunables.cpu_freq)</span>
00198 <span class="preprocessor"></span>
00199 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rtai_rdtsc (<span class="keywordtype">void</span>) {
00200 
00201         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ts;
00202         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> chk;
00203         <span class="comment">/* See Motorola reference manual for 32 bits PPCs. */</span>
00204         __asm__ __volatile__ (<span class="stringliteral">"1: mftbu %0\n"</span>
00205                               <span class="stringliteral">"   mftb %1\n"</span>
00206                               <span class="stringliteral">"   mftbu %2\n"</span>
00207                               <span class="stringliteral">"   cmpw %2,%0\n"</span>
00208                               <span class="stringliteral">"   bne 1b\n"</span>
00209                               : <span class="stringliteral">"=r"</span> (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ts)[0]), 
00210                                 <span class="stringliteral">"=r"</span> (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)&amp;ts)[1]), 
00211                                 <span class="stringliteral">"=r"</span> (chk));
00212         <span class="keywordflow">return</span> ts;
00213 }
00214 
00215 <span class="keyword">struct </span>calibration_data {
00216 
00217     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cpu_freq;
00218     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> apic_freq;
00219     <span class="keywordtype">int</span> latency;
00220     <span class="keywordtype">int</span> setup_time_TIMER_CPUNIT;
00221     <span class="keywordtype">int</span> setup_time_TIMER_UNIT;
00222     <span class="keywordtype">int</span> timers_tol[RTAI_NR_CPUS];
00223 };
00224 
00225 <span class="keyword">struct </span>apic_timer_setup_data {
00226 
00227     <span class="keywordtype">int</span> mode;
00228     <span class="keywordtype">int</span> count;
00229 };
00230 
00231 <span class="keyword">extern</span> <span class="keyword">struct </span>rt_times rt_times;
00232 
00233 <span class="keyword">extern</span> <span class="keyword">struct </span>rt_times rt_smp_times[RTAI_NR_CPUS];
00234 
00235 <span class="keyword">extern</span> <span class="keyword">struct </span>calibration_data rtai_tunables;
00236 
00237 <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_status;
00238 
00239 <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_cpu_realtime;
00240 
00241 <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_cpu_lock;
00242 
00243 <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rtai_cpu_lxrt;
00244 
00245 <span class="keyword">extern</span> <span class="keyword">struct </span>rtai_switch_data {
00246     <span class="keyword">struct </span>task_struct *oldtask;
00247     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> oldflags;
00248 } rtai_linux_context[RTAI_NR_CPUS];
00249 
00250 <span class="keyword">extern</span> adomain_t rtai_domain;
00251 
00252 <span class="keyword">extern</span> <span class="keywordtype">int</span> rtai_adeos_ptdbase;
00253 
00254 <span class="comment">/* rtai_get_current() is Adeos-specific. Since real-time interrupt</span>
00255 <span class="comment">   handlers are called on behalf of the RTAI domain stack, we cannot</span>
00256 <span class="comment">   infere the "current" Linux task address using %esp. We must use the</span>
00257 <span class="comment">   suspended Linux domain's stack pointer instead. */</span>
00258 
00259 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>task_struct *rtai_get_current (<span class="keywordtype">int</span> cpuid)
00260 
00261 {
00262     <span class="keyword">register</span> <span class="keywordtype">int</span> *esp <span class="keyword">asm</span> (<span class="stringliteral">"r1"</span>);
00263 <span class="preprocessor">#ifdef FIXME</span>
00264 <span class="preprocessor"></span>    __asm__ <span class="keyword">volatile</span>(<span class="stringliteral">"movl %%esp, %0"</span> : <span class="stringliteral">"=r"</span> (esp));
00265 <span class="preprocessor">#endif</span>
00266 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (esp &gt;= rtai_domain.estackbase[cpuid] &amp;&amp; esp &lt; rtai_domain.estackbase[cpuid] + 2048)
00267         <span class="keywordflow">return</span> (<span class="keyword">struct </span>task_struct *)(((u_long)adp_root-&gt;esp[cpuid]) &amp; (~8191UL));
00268 
00269     <span class="keywordflow">return</span> current;
00270 }
00271 
00272 <span class="preprocessor">#define rt_spin_lock(lock)    spin_lock(lock)</span>
00273 <span class="preprocessor"></span><span class="preprocessor">#define rt_spin_unlock(lock)  spin_unlock(lock)</span>
00274 <span class="preprocessor"></span>
00275 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_lock_irq(spinlock_t *lock) {
00276 
00277     rtai_cli();
00278     rt_spin_lock(lock);
00279 }
00280 
00281 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_unlock_irq(spinlock_t *lock) {
00282 
00283     rt_spin_unlock(lock);
00284     rtai_sti();
00285 }
00286 
00287 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rt_spin_lock_irqsave(spinlock_t *lock) {
00288 
00289     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags;
00290     rtai_local_irq_save(flags);
00291     rt_spin_lock(lock);
00292     <span class="keywordflow">return</span> flags;
00293 }
00294 
00295 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_spin_unlock_irqrestore(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags,
00296                                              spinlock_t *lock) {
00297     rt_spin_unlock(lock);
00298     rtai_local_irq_restore(flags);
00299 }
00300 
00301 <span class="preprocessor">#ifdef CONFIG_SMP</span>
00302 <span class="preprocessor"></span>
00303 <span class="preprocessor">#define CPU_RELAX(x) \</span>
00304 <span class="preprocessor">do { \</span>
00305 <span class="preprocessor">   int i = 0; \</span>
00306 <span class="preprocessor">   do \</span>
00307 <span class="preprocessor">     cpu_relax(); \</span>
00308 <span class="preprocessor">   while (++i &lt; x); \</span>
00309 <span class="preprocessor">} while(0)</span>
00310 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* !CONFIG_SMP */</span>
00311 <span class="preprocessor">#define CPU_RELAX(x)</span>
00312 <span class="preprocessor"></span>
00313 <span class="keywordtype">void</span> rtai_broadcast_to_timers(<span class="keywordtype">int</span> irq,
00314                               <span class="keywordtype">void</span> *dev_id,
00315                               <span class="keyword">struct</span> pt_regs *regs);
00316 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_SMP */</span>
00317 
00318 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_get_global_lock(<span class="keywordtype">void</span>) {
00319 
00320     adeos_declare_cpuid;
00321 
00322     rtai_cli();
00323 
00324 <span class="preprocessor">#ifdef adeos_load_cpuid</span>
00325 <span class="preprocessor"></span>    adeos_load_cpuid();
00326 <span class="preprocessor">#endif </span><span class="comment">/* adeos_load_cpuid */</span>
00327 
00328     <span class="keywordflow">if</span> (!test_and_set_bit(cpuid,&amp;rtai_cpu_lock))
00329         <span class="keywordflow">while</span> (test_and_set_bit(31,&amp;rtai_cpu_lock))
00330             CPU_RELAX(cpuid);
00331 }
00332 
00333 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_release_global_lock(<span class="keywordtype">void</span>) {
00334 
00335     adeos_declare_cpuid;
00336 
00337     rtai_cli();
00338 
00339 <span class="preprocessor">#ifdef adeos_load_cpuid</span>
00340 <span class="preprocessor"></span>    adeos_load_cpuid();
00341 <span class="preprocessor">#endif </span><span class="comment">/* adeos_load_cpuid */</span>
00342 
00343     <span class="keywordflow">if</span> (test_and_clear_bit(cpuid,&amp;rtai_cpu_lock)) {
00344         clear_bit(31,&amp;rtai_cpu_lock);
00345         CPU_RELAX(cpuid);
00346     }
00347 }
00348 
00361 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_cli(<span class="keywordtype">void</span>) {
00362     rt_get_global_lock();
00363 }
00364 
00371 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_sti(<span class="keywordtype">void</span>) {
00372     rt_release_global_lock();
00373     rtai_sti();
00374 }
00375 
00382 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rt_global_save_flags_and_cli(<span class="keywordtype">void</span>) {
00383 
00384     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags = rtai_get_iflag_and_cli();
00385     adeos_declare_cpuid;
00386 
00387 <span class="preprocessor">#ifdef adeos_load_cpuid</span>
00388 <span class="preprocessor"></span>    adeos_load_cpuid();
00389 <span class="preprocessor">#endif </span><span class="comment">/* adeos_load_cpuid */</span>
00390 
00391     <span class="keywordflow">if</span> (!test_and_set_bit(cpuid,&amp;rtai_cpu_lock))
00392         {
00393         <span class="keywordflow">while</span> (test_and_set_bit(31,&amp;rtai_cpu_lock))
00394             CPU_RELAX(cpuid);
00395 
00396         <span class="keywordflow">return</span> flags | 1;
00397         }
00398 
00399     <span class="keywordflow">return</span> flags;
00400 }
00401 
00409 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_save_flags(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *flags) {
00410 
00411     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hflags = rtai_get_iflag_and_cli(), rflags;
00412     adeos_declare_cpuid;
00413 
00414 <span class="preprocessor">#ifdef adeos_load_cpuid</span>
00415 <span class="preprocessor"></span>    adeos_load_cpuid();
00416 <span class="preprocessor">#endif </span><span class="comment">/* adeos_load_cpuid */</span>
00417 
00418     <span class="keywordflow">if</span> (test_bit(cpuid,&amp;rtai_cpu_lock))
00419         rflags = hflags;
00420     <span class="keywordflow">else</span>
00421         rflags = hflags | 1;
00422 
00423     <span class="keywordflow">if</span> (hflags)
00424         rtai_sti();
00425 
00426     *flags = rflags;
00427 }
00428 
00436 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_global_restore_flags(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> flags) {
00437 
00438     <span class="keywordflow">switch</span> (flags)
00439         {
00440         <span class="keywordflow">case</span> (1 &lt;&lt; RTAI_IFLAG) | 1:
00441 
00442             rt_release_global_lock();
00443             rtai_sti();
00444             <span class="keywordflow">break</span>;
00445 
00446         <span class="keywordflow">case</span> (1 &lt;&lt; RTAI_IFLAG) | 0:
00447 
00448             rt_get_global_lock();
00449             rtai_sti();
00450             <span class="keywordflow">break</span>;
00451 
00452         <span class="keywordflow">case</span> (0 &lt;&lt; RTAI_IFLAG) | 1:
00453 
00454             rt_release_global_lock();
00455             <span class="keywordflow">break</span>;
00456 
00457         <span class="keywordflow">case</span> (0 &lt;&lt; RTAI_IFLAG) | 0:
00458 
00459             rt_get_global_lock();
00460             <span class="keywordflow">break</span>;
00461         }
00462 }
00463 
00464 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_switch_to_real_time(<span class="keywordtype">int</span> cpuid) {
00465 
00466     TRACE_RTAI_SWITCHTO_RT(cpuid);
00467     rtai_linux_context[cpuid].oldtask = rtai_get_current(cpuid);
00468     rtai_linux_context[cpuid].oldflags = rtai_linux_save_flags_and_cli();
00469     set_bit(cpuid,&amp;rtai_cpu_realtime);
00470 }
00471 
00472 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_switch_to_linux(<span class="keywordtype">int</span> cpuid) {
00473 
00474     TRACE_RTAI_SWITCHTO_LINUX(cpuid);
00475     clear_bit(cpuid,&amp;rtai_cpu_realtime);
00476     rtai_linux_restore_flags_nosync(rtai_linux_context[cpuid].oldflags,cpuid);
00477     rtai_linux_context[cpuid].oldtask = NULL;
00478 }
00479 
00480 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>task_struct *rt_whoislinux(<span class="keywordtype">int</span> cpuid) {
00481 
00482     <span class="keywordflow">return</span> rtai_linux_context[cpuid].oldtask;
00483 }
00484 
00485 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rt_is_linux (<span class="keywordtype">void</span>) {
00486 
00487     <span class="keywordflow">return</span> !test_bit(adeos_processor_id(),&amp;rtai_cpu_realtime);
00488 }
00489 
00490 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> rt_is_lxrt (<span class="keywordtype">void</span>) {
00491 
00492     <span class="keywordflow">return</span> test_bit(adeos_processor_id(),&amp;rtai_cpu_lxrt);
00493 }
00494 
00495 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> rt_set_timer_delay (<span class="keywordtype">int</span> delay) {
00496 
00497     <span class="comment">/* NOTE: delay MUST be 0 if a periodic timer is being used. */</span>
00498     <span class="keywordflow">if</span> (delay == 0) 
00499         {
00500 <span class="preprocessor">#ifdef CONFIG_40x</span>
00501 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
00502 <span class="preprocessor">#else  </span><span class="comment">/* !CONFIG_40x */</span>
00503         <span class="keywordflow">if</span> ((delay = rt_times.intr_time - rtai_rdtsc()) &lt;= 0)
00504             {
00505             <span class="keywordtype">int</span> lost = 0;
00506             <span class="keywordflow">do</span> 
00507                 {
00508                 lost++;
00509                 rt_times.intr_time += (RTIME)rt_times.periodic_tick;
00510                 }
00511             <span class="keywordflow">while</span> ((delay = rt_times.intr_time - rtai_rdtsc()) &lt;= 0);
00512             printk(<span class="stringliteral">"%d timer interrupt(s) lost\n"</span>, lost);
00513             }
00514 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_40x */</span>
00515         }
00516 <span class="preprocessor">#ifdef CONFIG_40x</span>
00517 <span class="preprocessor"></span>    mtspr(SPRN_PIT, delay);
00518 <span class="preprocessor">#else</span>
00519 <span class="preprocessor"></span>    set_dec(delay);
00520 <span class="preprocessor">#endif</span>
00521 <span class="preprocessor"></span>}
00522 
00523     <span class="comment">/* Private interface -- Internal use only */</span>
00524 
00525 <span class="preprocessor">#ifdef FIXME</span>
00526 <span class="preprocessor"></span><span class="keywordtype">void</span> rtai_attach_lxrt(<span class="keywordtype">void</span>);
00527 
00528 <span class="keywordtype">void</span> rtai_detach_lxrt(<span class="keywordtype">void</span>);
00529 
00530 <span class="keywordtype">void</span> rtai_switch_linux_mm(<span class="keyword">struct</span> task_struct *prev,
00531                           <span class="keyword">struct</span> task_struct *next,
00532                           <span class="keywordtype">int</span> cpuid);
00533 <span class="preprocessor">#endif</span>
00534 <span class="preprocessor"></span>
00535 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ &amp;&amp; !__cplusplus */</span>
00536 
00537     <span class="comment">/* Public interface */</span>
00538 
00539 <span class="preprocessor">#ifdef __KERNEL__</span>
00540 <span class="preprocessor"></span>
00541 <span class="preprocessor">#include &lt;linux/kernel.h&gt;</span>
00542 
00543 <span class="preprocessor">#ifdef __cplusplus</span>
00544 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00545 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00546 
00547 <span class="keywordtype">int</span> rt_request_irq(<span class="keywordtype">unsigned</span> irq,
00548                    <span class="keywordtype">void</span> (*handler)(<span class="keywordtype">unsigned</span> irq, <span class="keywordtype">void</span> *cookie),
00549                    <span class="keywordtype">void</span> *cookie);
00550 
00551 <span class="keywordtype">int</span> rt_release_irq(<span class="keywordtype">unsigned</span> irq);
00552 
00553 <span class="keywordtype">void</span> rt_set_irq_cookie(<span class="keywordtype">unsigned</span> irq,
00554                        <span class="keywordtype">void</span> *cookie);
00555 
00560 <span class="keywordtype">unsigned</span> rt_startup_irq(<span class="keywordtype">unsigned</span> irq);
00561 
00562 <span class="keywordtype">void</span> rt_shutdown_irq(<span class="keywordtype">unsigned</span> irq);
00563 
00564 <span class="keywordtype">void</span> rt_enable_irq(<span class="keywordtype">unsigned</span> irq);
00565 
00566 <span class="keywordtype">void</span> rt_disable_irq(<span class="keywordtype">unsigned</span> irq);
00567 
00568 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga78">rt_mask_and_ack_irq</a>(<span class="keywordtype">unsigned</span> irq);
00569 
00570 <span class="keywordtype">void</span> rt_unmask_irq(<span class="keywordtype">unsigned</span> irq);
00571 
00572 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga80">rt_ack_irq</a>(<span class="keywordtype">unsigned</span> irq);
00575 <span class="keywordtype">void</span> rt_do_irq(<span class="keywordtype">unsigned</span> irq);
00576 
00577 <span class="keywordtype">int</span> rt_request_linux_irq(<span class="keywordtype">unsigned</span> irq,
00578                          <span class="keywordtype">void</span> (*handler)(<span class="keywordtype">int</span> irq,
00579                                          <span class="keywordtype">void</span> *dev_id,
00580                                          <span class="keyword">struct</span> pt_regs *regs), 
00581                          <span class="keywordtype">char</span> *name,
00582                          <span class="keywordtype">void</span> *dev_id);
00583 
00584 <span class="keywordtype">int</span> rt_free_linux_irq(<span class="keywordtype">unsigned</span> irq,
00585                       <span class="keywordtype">void</span> *dev_id);
00586 
00587 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga84">rt_pend_linux_irq</a>(<span class="keywordtype">unsigned</span> irq);
00588 
00589 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga87">rt_pend_linux_srq</a>(<span class="keywordtype">unsigned</span> srq);
00590 
00591 <span class="keywordtype">int</span> rt_request_srq(<span class="keywordtype">unsigned</span> label,
00592                    <span class="keywordtype">void</span> (*k_handler)(<span class="keywordtype">void</span>),
00593                    <span class="keywordtype">long</span> <span class="keywordtype">long</span> (*u_handler)(<span class="keywordtype">unsigned</span>));
00594 
00595 <span class="keywordtype">int</span> rt_free_srq(<span class="keywordtype">unsigned</span> srq);
00596 
00597 <span class="keywordtype">int</span> rt_assign_irq_to_cpu(<span class="keywordtype">int</span> irq,
00598                          <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cpus_mask);
00599 
00600 <span class="keywordtype">int</span> rt_reset_irq_to_sym_mode(<span class="keywordtype">int</span> irq);
00601 
00602 <span class="keywordtype">void</span> rt_request_timer_cpuid(<span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>),
00603                             <span class="keywordtype">unsigned</span> tick,
00604                             <span class="keywordtype">int</span> cpuid);
00605 
00606 <span class="preprocessor">#ifdef FIXME</span>
00607 <span class="preprocessor"></span><span class="keywordtype">void</span> rt_request_apic_timers(<span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>),
00608                             <span class="keyword">struct</span> apic_timer_setup_data *tmdata);
00609 
00610 <span class="keywordtype">void</span> rt_free_apic_timers(<span class="keywordtype">void</span>);
00611 <span class="preprocessor">#endif</span>
00612 <span class="preprocessor"></span>
00613 <span class="keywordtype">int</span> rt_request_timer(<span class="keywordtype">void</span> (*handler)(<span class="keywordtype">void</span>),
00614                      <span class="keywordtype">unsigned</span> tick,
00615                      <span class="keywordtype">int</span> use_apic);
00616 
00617 <span class="keywordtype">void</span> <a class="code" href="group__hal.html#ga94">rt_free_timer</a>(<span class="keywordtype">void</span>);
00618 
00619 <span class="preprocessor">#ifdef FIXME</span>
00620 <span class="preprocessor"></span>RT_TRAP_HANDLER rt_set_trap_handler(RT_TRAP_HANDLER handler);
00621 <span class="preprocessor">#endif</span>
00622 <span class="preprocessor"></span>
00623 <span class="keywordtype">void</span> rt_mount(<span class="keywordtype">void</span>);
00624 
00625 <span class="keywordtype">void</span> rt_umount(<span class="keywordtype">void</span>);
00626 
00627 void (*rt_set_ihook(<span class="keywordtype">void</span> (*hookfn)(<span class="keywordtype">int</span>)))(int);
00628 
00629 <span class="preprocessor">#define rt_printk printk </span><span class="comment">/* This is safe over Adeos */</span>
00630 
00631 <span class="preprocessor">#ifdef __cplusplus</span>
00632 <span class="preprocessor"></span>}
00633 <span class="preprocessor">#endif </span><span class="comment">/* __cplusplus */</span>
00634 
00635 <span class="preprocessor">#endif </span><span class="comment">/* __KERNEL__ */</span>
00636 
00637 <span class="preprocessor">#include &lt;asm/rtai_oldnames.h&gt;</span>
00638 
00639 <span class="preprocessor">#define RTAI_DEFAULT_TICK    100000</span>
00640 <span class="preprocessor"></span><span class="preprocessor">#ifdef CONFIG_RTAI_TRACE</span>
00641 <span class="preprocessor"></span><span class="preprocessor">#define RTAI_DEFAULT_STACKSZ 8192</span>
00642 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* !CONFIG_RTAI_TRACE */</span>
00643 <span class="preprocessor">#define RTAI_DEFAULT_STACKSZ 4092</span>
00644 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CONFIG_RTAI_TRACE */</span>
00645 
00648 <span class="preprocessor">#endif </span><span class="comment">/* !_RTAI_ASM_PPC_HAL_H */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 18 22:53:52 2005 for RTAI API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>

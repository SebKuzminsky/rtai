<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RTAI API: base/include/asm-ppc/rtai_fpu.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">base</a>&nbsp;/&nbsp;<a class="el" href="dir_000015.html">include</a>&nbsp;/&nbsp;<a class="el" href="dir_000021.html">asm-ppc</a></div>
<h1>rtai_fpu.h</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">COPYRIGHT (C) 2000  Paolo Mantegazza (mantegazza@aero.polimi.it)</span>
00003 <span class="comment"></span>
00004 <span class="comment">This library is free software; you can redistribute it and/or</span>
00005 <span class="comment">modify it under the terms of the GNU Lesser General Public</span>
00006 <span class="comment">License as published by the Free Software Foundation; either</span>
00007 <span class="comment">version 2 of the License, or (at your option) any later version.</span>
00008 <span class="comment"></span>
00009 <span class="comment">This library is distributed in the hope that it will be useful,</span>
00010 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00012 <span class="comment">Lesser General Public License for more details.</span>
00013 <span class="comment"></span>
00014 <span class="comment">You should have received a copy of the GNU Lesser General Public</span>
00015 <span class="comment">License along with this library; if not, write to the Free Software</span>
00016 <span class="comment">Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA.</span>
00017 <span class="comment">*/</span>
00018 
00019 <span class="preprocessor">#ifndef _RTAI_ASM_PPC_FPU_H_</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define _RTAI_ASM_PPC_FPU_H_</span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor">#include &lt;asm/processor.h&gt;</span>
00023 
00024 <span class="keyword">typedef</span> <span class="keyword">struct </span>ppc_fpu_env { <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> fpu_reg[66]; } FPU_ENV;
00025 
00026 <span class="preprocessor">#define save_cr0_and_clts(x)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#define restore_cr0(x)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#define enable_fpu()</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#ifdef CONFIG_RTAI_FPU_SUPPORT</span>
00031 <span class="preprocessor"></span><span class="comment">/*</span>
00032 <span class="comment"> * Saving/restoring the FPU environment in PPC is like eating a cake, very simple. Just save/restore all of the floating </span>
00033 <span class="comment"> * point registers, recall they are always 64 bits long, and the floating point state register. Remark: at task init we</span>
00034 <span class="comment"> * always enable FP, i.e. MSR flag FP set to 1, for real time tasks and accept default actions for faulty FLOPs, i.e. MSR </span>
00035 <span class="comment"> * flags FE0 and FE1 are set to zero.</span>
00036 <span class="comment"> */</span>
00037 
00038 <span class="preprocessor">#define stringize(a) #a</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#define str(a) stringize(a)</span>
00040 <span class="preprocessor"></span>
00041 <span class="keyword">extern</span> <span class="keywordtype">void</span> __save_fpenv(FPU_ENV *fpenv);
00042 <span class="preprocessor">#define save_fpenv(x) __save_fpenv(&amp;(x))</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#if 0</span>
00044 <span class="preprocessor"></span><span class="comment">// FIXME: it does not work, waiting for cleanup!</span>
00045 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __save_fpenv(FPU_ENV *env)
00046 {
00047         <span class="keyword">asm</span>(
00048         <span class="stringliteral">"stw     0,  -4(1)\n"</span>
00049         <span class="stringliteral">"mfmsr    0\n"</span>
00050         <span class="stringliteral">"ori      0, 0, "</span> str(MSR_FP) <span class="stringliteral">"\n"</span>
00051         <span class="stringliteral">"mtmsr    0\n"</span>
00052         <span class="stringliteral">"lwz      0,  -4(1)\n"</span>
00053         <span class="stringliteral">"isync\n"</span>
00054         <span class="stringliteral">"stfd    0, 0*8(3)\n"</span>
00055         <span class="stringliteral">"stfd    1, 1*8(3)\n"</span>
00056         <span class="stringliteral">"stfd    2, 2*8(3)\n"</span>
00057         <span class="stringliteral">"stfd    3, 3*8(3)\n"</span>
00058         <span class="stringliteral">"stfd    4, 4*8(3)\n"</span>
00059         <span class="stringliteral">"stfd    5, 5*8(3)\n"</span>
00060         <span class="stringliteral">"stfd    6, 6*8(3)\n"</span>
00061         <span class="stringliteral">"stfd    7, 7*8(3)\n"</span>
00062         <span class="stringliteral">"stfd    8, 8*8(3)\n"</span>
00063         <span class="stringliteral">"stfd    9, 9*8(3)\n"</span>
00064         <span class="stringliteral">"stfd   10,10*8(3)\n"</span>
00065         <span class="stringliteral">"stfd   11,11*8(3)\n"</span>
00066         <span class="stringliteral">"stfd   12,12*8(3)\n"</span>
00067         <span class="stringliteral">"stfd   13,13*8(3)\n"</span>
00068         <span class="stringliteral">"stfd   14,14*8(3)\n"</span>
00069         <span class="stringliteral">"stfd   15,15*8(3)\n"</span>
00070         <span class="stringliteral">"stfd   16,16*8(3)\n"</span>
00071         <span class="stringliteral">"stfd   17,17*8(3)\n"</span>
00072         <span class="stringliteral">"stfd   18,18*8(3)\n"</span>
00073         <span class="stringliteral">"stfd   19,19*8(3)\n"</span>
00074         <span class="stringliteral">"stfd   20,20*8(3)\n"</span>
00075         <span class="stringliteral">"stfd   21,21*8(3)\n"</span>
00076         <span class="stringliteral">"stfd   22,22*8(3)\n"</span>
00077         <span class="stringliteral">"stfd   23,23*8(3)\n"</span>
00078         <span class="stringliteral">"stfd   24,24*8(3)\n"</span>
00079         <span class="stringliteral">"stfd   25,25*8(3)\n"</span>
00080         <span class="stringliteral">"stfd   26,26*8(3)\n"</span>
00081         <span class="stringliteral">"stfd   27,27*8(3)\n"</span>
00082         <span class="stringliteral">"stfd   28,28*8(3)\n"</span>
00083         <span class="stringliteral">"stfd   29,29*8(3)\n"</span>
00084         <span class="stringliteral">"stfd   30,30*8(3)\n"</span>
00085         <span class="stringliteral">"stfd   31,31*8(3)\n"</span>
00086         <span class="stringliteral">"mffs    0\n"</span>
00087         <span class="stringliteral">"stfd    0,32*8(3)\n"</span>);
00088 }
00089 <span class="preprocessor">#endif</span>
00090 <span class="preprocessor"></span>
00091 <span class="keyword">extern</span> <span class="keywordtype">void</span> __restore_fpenv(FPU_ENV *fpenv);
00092 <span class="preprocessor">#define restore_fpenv(x) __restore_fpenv(&amp;(x))</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#if 0</span>
00094 <span class="preprocessor"></span><span class="comment">// FIXME: it does not work, waiting for cleanup!</span>
00095 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __restore_fpenv(FPU_ENV *env)
00096 {
00097         <span class="keyword">asm</span>(
00098         <span class="stringliteral">"lfd     0, 32*8(3)\n"</span>
00099         <span class="stringliteral">"mtfsf   0xFF,0\n"</span>
00100         <span class="stringliteral">"lfd     0, 0*8(3)\n"</span>
00101         <span class="stringliteral">"lfd     1, 1*8(3)\n"</span>
00102         <span class="stringliteral">"lfd     2, 2*8(3)\n"</span>
00103         <span class="stringliteral">"lfd     3, 3*8(3)\n"</span>
00104         <span class="stringliteral">"lfd     4, 4*8(3)\n"</span>
00105         <span class="stringliteral">"lfd     5, 5*8(3)\n"</span>
00106         <span class="stringliteral">"lfd     6, 6*8(3)\n"</span>
00107         <span class="stringliteral">"lfd     7, 7*8(3)\n"</span>
00108         <span class="stringliteral">"lfd     8, 8*8(3)\n"</span>
00109         <span class="stringliteral">"lfd     9, 9*8(3)\n"</span>
00110         <span class="stringliteral">"lfd    10,10*8(3)\n"</span>
00111         <span class="stringliteral">"lfd    11,11*8(3)\n"</span>
00112         <span class="stringliteral">"lfd    12,12*8(3)\n"</span>
00113         <span class="stringliteral">"lfd    13,13*8(3)\n"</span>
00114         <span class="stringliteral">"lfd    14,14*8(3)\n"</span>
00115         <span class="stringliteral">"lfd    15,15*8(3)\n"</span>
00116         <span class="stringliteral">"lfd    16,16*8(3)\n"</span>
00117         <span class="stringliteral">"lfd    17,17*8(3)\n"</span>
00118         <span class="stringliteral">"lfd    18,18*8(3)\n"</span>
00119         <span class="stringliteral">"lfd    19,19*8(3)\n"</span>
00120         <span class="stringliteral">"lfd    20,20*8(3)\n"</span>
00121         <span class="stringliteral">"lfd    21,21*8(3)\n"</span>
00122         <span class="stringliteral">"lfd    22,22*8(3)\n"</span>
00123         <span class="stringliteral">"lfd    23,23*8(3)\n"</span>
00124         <span class="stringliteral">"lfd    24,24*8(3)\n"</span>
00125         <span class="stringliteral">"lfd    25,25*8(3)\n"</span>
00126         <span class="stringliteral">"lfd    26,26*8(3)\n"</span>
00127         <span class="stringliteral">"lfd    27,27*8(3)\n"</span>
00128         <span class="stringliteral">"lfd    28,28*8(3)\n"</span>
00129         <span class="stringliteral">"lfd    29,29*8(3)\n"</span>
00130         <span class="stringliteral">"lfd    30,30*8(3)\n"</span>
00131         <span class="stringliteral">"lfd    31,31*8(3)\n"</span>);
00132 }
00133 <span class="preprocessor">#endif</span>
00134 <span class="preprocessor"></span>
00135 <span class="preprocessor">#else</span>
00136 <span class="preprocessor"></span>
00137 <span class="preprocessor">#define save_fpenv(x)</span>
00138 <span class="preprocessor"></span><span class="preprocessor">#define restore_fpenv(x)</span>
00139 <span class="preprocessor"></span>
00140 <span class="preprocessor">#endif</span>
00141 <span class="preprocessor"></span>
00142 
00143 <span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 18 22:53:52 2005 for RTAI API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>

#!/bin/bash
# This script automatically updates the debian packaging files for
# the current build.
set -x

function subst() {
    cp $1.in $1
    sed --in-place \
        -e "s/@KERNEL_VERSION@/$KERNEL_VERSION/g" \
        -e "s/@KERNEL_HEADERS@/$KERNEL_HEADERS/g" \
        $*
}


RTAI_VERSION=$(git describe --tags | sed -e 'y/-/./')

if [ -z "$1" ]; then
    echo "usage: ./configure TARGET_KERNEL"
    echo TARGET_KERNEL is the kernel version to compile against,
    echo for example 3.4-9-rtai-686-pae
    exit 1
fi

KERNEL_VERSION=$1
shift

FLAVORS="$@"
KERNEL_HEADERS=""
for FLAVOR in $FLAVORS; do
    if [ -z "$KERNEL_HEADERS" ]; then
        KERNEL_HEADERS="linux-headers-$KERNEL_VERSION-$FLAVOR"
    else
        KERNEL_HEADERS="$KERNEL_HEADERS | linux-headers-$KERNEL_VERSION-$FLAVOR"
    fi
done

subst debian/control
subst debian/rules

